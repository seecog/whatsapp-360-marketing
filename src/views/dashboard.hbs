<!-- Allow fully expanded submenus on this page -->
{{! <style>
    /* allow the sidebar to scroll if content exceeds screen height */
    .sidebar {
        max-height: 100vh;
        overflow-y: auto;
        /* <-- key fix */
    }

    /* remove the 200px cap from the global stylesheet */
    .sidebar .submenu.show {
        max-height: none !important;
        /* beat the head CSS */
        overflow: visible !important;
    }
</style> }}

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 px-0">
      <div class="sidebar p-3">
        <div class="text-center mb-2">
          <h5 class="text-white">WhatsApp Manager</h5>
          <small class="text-white-50">{{user.firstName}}
            {{user.lastName}}</small>
        </div>
        <nav class="nav flex-column">
          <!-- WhatsApp Menu -->
          <div class="menu-toggle" onclick="toggleMenu('whatsapp-submenu')">
            <div class="nav-link">
              <i class="fab fa-whatsapp"></i>
              WhatsApp
              <i class="fas fa-chevron-down float-end"></i>
            </div>
          </div>
          <div class="submenu show" id="whatsapp-submenu">
            <a class="nav-link active" href="/dashboard">
              <i class="fas fa-tachometer-alt"></i>
              Dashboard
            </a>
            <a class="nav-link" href="/business">
              <i class="fas fa-building"></i>
              Business
            </a>
            <a class="nav-link" href="/customers">
              <i class="fas fa-users"></i>
              Customers
            </a>
            <a class="nav-link" href="/templates">
              <i class="fas fa-file-alt"></i>
              Templates
            </a>
            <a class="nav-link" href="/campaigns">
              <i class="fas fa-bullhorn"></i>
              Campaigns
            </a>

          </div>

          <!-- HR Tools Menu -->
          <div class="menu-toggle" onclick="toggleMenu('hr-submenu')">
            <div class="nav-link">
              <i class="fas fa-users-cog"></i>
              HR Tools
              <i class="fas fa-chevron-down float-end"></i>
            </div>
          </div>
          <div class="submenu" id="hr-submenu">
            <a class="nav-link" href="/employees"><i
                class="fas fa-user-tie"
              ></i>
              Employees</a>
            <a class="nav-link" href="/documents"><i
                class="fas fa-file-signature"
              ></i>
              Documents</a>
          </div>

          <!-- Utilities -->
          <div
            class="menu-toggle mt-2"
            onclick="toggleMenu('utilities-submenu')"
          >
            <div class="nav-link">
              <i class="fas fa-tools"></i>
              Utilities
              <i class="fas fa-chevron-down float-end"></i>
            </div>
          </div>
          <div class="submenu" id="utilities-submenu">
            <a class="nav-link" href="/document-types"><i
                class="fas fa-layer-group"
              ></i>
              Document Types</a>
              <a class="nav-link" href="/email-templates">
              <i class="fas fa-envelope-open-text"></i>
              Email Templates
            </a>
          </div>

          <hr class="text-white-50" />
          <a class="nav-link" href="#" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </a>
        </nav>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10">
      <div class="main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Dashboard</h2>
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#addCustomerModal"
          >
            <i class="fas fa-plus me-2"></i>Add Customer
          </button>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
          <div class="col-md-2 mb-3">
            <div
              class="card text-center h-100"
              style="cursor: pointer; transition: all 0.3s ease;"
              onclick="window.location.href='/business'"
              onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
            >
              <div class="card-body">
                <i class="fas fa-building fa-2x text-primary mb-2"></i>
                <h5 class="card-title" id="totalBusinesses">0</h5>
                <p class="card-text text-muted">Businesses</p>
                <small class="text-primary"><i
                    class="fas fa-external-link-alt me-1"
                  ></i>View All</small>
              </div>
            </div>
          </div>
          <div class="col-md-2 mb-3">
            <div
              class="card text-center h-100"
              style="cursor: pointer; transition: all 0.3s ease;"
              onclick="window.location.href='/customers'"
              onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
            >
              <div class="card-body">
                <i class="fas fa-users fa-2x text-success mb-2"></i>
                <h5 class="card-title" id="totalCustomers">0</h5>
                <p class="card-text text-muted">Customers</p>
                <small class="text-success"><i
                    class="fas fa-external-link-alt me-1"
                  ></i>View All</small>
              </div>
            </div>
          </div>
          <div class="col-md-2 mb-3">
            <div
              class="card text-center h-100"
              style="cursor: pointer; transition: all 0.3s ease;"
              onclick="window.location.href='/templates'"
              onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
            >
              <div class="card-body">
                <i class="fas fa-file-alt fa-2x text-warning mb-2"></i>
                <h5 class="card-title" id="totalTemplates">0</h5>
                <p class="card-text text-muted">Templates</p>
                <small class="text-warning"><i
                    class="fas fa-external-link-alt me-1"
                  ></i>View All</small>
              </div>
            </div>
          </div>
          <div class="col-md-2 mb-3">
            <div
              class="card text-center h-100"
              style="cursor: pointer; transition: all 0.3s ease;"
              onclick="window.location.href='/campaigns'"
              onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
            >
              <div class="card-body">
                <i class="fas fa-bullhorn fa-2x text-info mb-2"></i>
                <h5 class="card-title" id="totalCampaigns">0</h5>
                <p class="card-text text-muted">Campaigns</p>
                <small class="text-info"><i
                    class="fas fa-external-link-alt me-1"
                  ></i>View All</small>
              </div>
            </div>
          </div>
          <div class="col-md-2 mb-3">
            <div class="card text-center">
              <div class="card-body">
                <i class="fas fa-chart-line fa-2x text-secondary mb-2"></i>
                <h5 class="card-title" id="messagesSent">0</h5>
                <p class="card-text text-muted">Messages Sent</p>
              </div>
            </div>
          </div>
          <div class="col-md-2 mb-3">
            <div class="card text-center">
              <div class="card-body">
                <i class="fas fa-paper-plane fa-2x text-danger mb-2"></i>
                <h5 class="card-title" id="messagesSent">0</h5>
                <p class="card-text text-muted">Messages</p>
              </div>
            </div>
          </div>
          <div class="col-md-2 mb-3">
            <div class="card text-center">
              <div class="card-body">
                <i class="fas fa-chart-line fa-2x text-secondary mb-2"></i>
                <h5 class="card-title" id="successRate">0%</h5>
                <p class="card-text text-muted">Success Rate</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Customers -->
        <div class="card">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <h5 class="mb-0">Recent Customers</h5>
            <a href="/customers" class="btn btn-sm btn-outline-primary">View All</a>
          </div>
          <div class="card-body">
            <div id="customersList">
              <div class="text-center py-4">
                {{!-- <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div> --}}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Customer</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="addCustomerForm">
          <div class="mb-3">
            <label for="customerName" class="form-label">Name</label>
            <input
              type="text"
              class="form-control"
              id="customerName"
              name="name"
              required
            />
          </div>
          <div class="mb-3">
            <label for="customerPhone" class="form-label">Phone Number (E.164
              format)</label>
            <div class="input-group">
              <span class="input-group-text">+91</span>
              <input
                type="tel"
                class="form-control"
                id="customerPhone"
                name="phoneE164"
                placeholder="9999999999"
                required
              />
            </div>
            <small class="form-text text-muted">Enter 10-digit mobile number
              without +91</small>
          </div>
          <div class="mb-3">
            <label for="customerTags" class="form-label">Tags (comma separated)</label>
            <input
              type="text"
              class="form-control"
              id="customerTags"
              name="tags"
              placeholder="vip, regular, premium"
            />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >Cancel</button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="addCustomer()"
        >Add Customer</button>
      </div>
    </div>
  </div>
</div>

<script>
  // API call helper function async function apiCall(url, options = {}) { const
  token = localStorage.getItem('accessToken') ||
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiaWF0IjoxNzU5NTc3OTg4LCJleHAiOjE3NTk2NjQzODh9.hQKxhtUpoBIYRwqIz27KXmqyF7KL1lPGNoYqEzNBMDQ';
  const defaultOptions = { headers: { 'Content-Type': 'application/json',
  'Authorization': `Bearer ${token}` } }; const response = await fetch(url, {
  ...defaultOptions, ...options }); return response; } // Load dashboard data
  async function loadDashboardData() { try { // Load businesses try { const
  businessesResponse = await apiCall('/api/v1/business'); if
  (businessesResponse.ok) { const businesses = await businessesResponse.json();
  document.getElementById('totalBusinesses').textContent = businesses.length; }
  else { document.getElementById('totalBusinesses').textContent = '0'; } } catch
  (error) { document.getElementById('totalBusinesses').textContent = '0'; }
  //Load customers 
  try { const customersResponse = await
  apiCall('/api/v1/customers'); if (customersResponse.ok) { const customers =
  await customersResponse.json();
  document.getElementById('totalCustomers').textContent = customers.length; }
  else { document.getElementById('totalCustomers').textContent = '0'; } } catch
  (error) { document.getElementById('totalCustomers').textContent = '0'; }
  //Load templates count 
  try { const templatesResponse = await
  apiCall('/api/v1/templates'); if (templatesResponse.ok) { const templates =
  await templatesResponse.json();
  document.getElementById('totalTemplates').textContent = templates.length; }
  else { console.error('Templates API error:', await templatesResponse.text());
  document.getElementById('totalTemplates').textContent = '0'; } } catch (error)
  { console.error('Error loading templates count:', error);
  document.getElementById('totalTemplates').textContent = '0'; } // Mock data
  for other stats(you can replace with real API calls later)
  document.getElementById('totalCampaigns').textContent = '0';
  document.getElementById('messagesSent').textContent = '0';
  document.getElementById('successRate').textContent = '0%'; // Display recent
  customers const customersList = document.getElementById('customersList'); let
  customers = []; try { const customersResponse = await
  apiCall('/api/v1/customers'); if (customersResponse.ok) { customers = await
  customersResponse.json(); } } catch (error) { console.error('Error loading
  customers for display: ', error); } if (customers.length > 0) {
  customersList.innerHTML = customers.slice(0, 5).map(customer => ` <div
  class="d-flex justify-content-between align-items-center py-2 border-bottom">
  <div> <h6 class="mb-1">${customer.name || 'No Name'}</h6> <small
  class="text-muted">${customer.phoneE164}</small> ${customer.business ?
  `<br><small class="text-info"><i class="fas fa-building
  me-1"></i>${customer.business.businessName}</small>` : ''} </div> <div>
  ${customer.tags && customer.tags.length > 0 ? customer.tags.map(tag => `<span
  class="badge bg-secondary me-1">${tag}</span>`).join('') : '<span class=
  "text-muted" > No tags</span > ' } </div> </div> `).join(''); } else {
  customersList.innerHTML = '<p class="text-muted text-center py-4">No customers
  found</p > '; } // Load campaigns count try { const campaignsResponse = await
  apiCall('/api/v1/campaigns'); if (campaignsResponse.ok) { const campaigns =
  await campaignsResponse.json();
  document.getElementById('totalCampaigns').textContent = campaigns.length; }
  else { document.getElementById('totalCampaigns').textContent = '0'; } } catch
  (error) { document.getElementById('totalCampaigns').textContent = '0'; } //
  Load other stats(you can implement these later)
  document.getElementById('messagesSent').textContent = '0'; } catch (error) {
  console.error('Error loading dashboard data:', error);
  document.getElementById('customersList').innerHTML = '<p class="text-danger
  text - center py - 4">Error loading data</p>'; } } // Add customer function
  async function addCustomer() { const form =
  document.getElementById('addCustomerForm'); const formData = new
  FormData(form); // Get phone number and prepend +91 if not already present let
  phoneNumber = formData.get('phoneE164'); if (phoneNumber &&
  !phoneNumber.startsWith('+91')) { phoneNumber = '+91' + phoneNumber; } const
  customerData = { name: formData.get('name'), phoneE164: phoneNumber, tags:
  formData.get('tags') ? formData.get('tags').split(',').map(tag =>
  tag.trim()).filter(tag => tag) : [], consentAt: new Date().toISOString() };
  try { const response = await apiCall('/customers', { method: 'POST', body:
  JSON.stringify(customerData) }); if (response.ok) { // Close modal and refresh
  data const modal =
  bootstrap.Modal.getInstance(document.getElementById('addCustomerModal'));
  modal.hide(); form.reset(); loadDashboardData(); // Show success message
  showAlert('Customer added successfully!', 'success'); } else { const error =
  await response.json(); showAlert(error.error || 'Failed to add customer',
  'danger'); } } catch (error) { showAlert('Network error. Please try again.',
  'danger'); } } function showAlert(message, type) { // Create alert element
  const alertDiv = document.createElement('div'); alertDiv.className = `alert
  alert-${type} alert-dismissible fade show position-fixed`;
  alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width:
  300px; '; alertDiv.innerHTML = ` ${message} <button type="button"
  class="btn-close" data - bs - dismiss="alert" ></button > `;
  document.body.appendChild(alertDiv); // Auto remove after 5 seconds
  setTimeout(() => { if (alertDiv.parentNode) {
  alertDiv.parentNode.removeChild(alertDiv); } }, 5000); } // Load data when
  page loads document.addEventListener('DOMContentLoaded', loadDashboardData);
</script>