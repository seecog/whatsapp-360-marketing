{{!-- views/documentTypes.hbs --}}
<div class="container-fluid">
  <div class="row">
    {{!-- Sidebar --}}
    <div class="col-md-3 col-lg-2 px-0">
      <div class="sidebar p-3">
        <div class="text-center mb-2">
          <h5 class="text-white">WhatsApp Manager</h5>
          <small class="text-white-50">{{user.firstName}} {{user.lastName}}</small>
        </div>
        <nav class="nav flex-column">
          <div class="menu-toggle" onclick="toggleMenu('whatsapp-submenu')">
            <div class="nav-link">
              <i class="fab fa-whatsapp"></i> WhatsApp
              <i class="fas fa-chevron-down float-end"></i>
            </div>
          </div>
          <div class="submenu show" id="whatsapp-submenu">
            <a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a class="nav-link" href="/business"><i class="fas fa-building"></i> Business</a>
            <a class="nav-link" href="/customers"><i class="fas fa-users"></i> Customers</a>
            <a class="nav-link" href="/templates"><i class="fas fa-file-alt"></i> Templates</a>
            <a class="nav-link" href="/campaigns"><i class="fas fa-bullhorn"></i> Campaigns</a>
          </div>

          <div class="menu-toggle mt-2" onclick="toggleMenu('hr-submenu')">
            <div class="nav-link">
              <i class="fas fa-users-cog"></i> HR Tools
              <i class="fas fa-chevron-down float-end"></i>
            </div>
          </div>
          <div class="submenu" id="hr-submenu">
            <a class="nav-link" href="/employees"><i class="fas fa-user-tie"></i> Employees</a>
            <a class="nav-link" href="/documents"><i class="fas fa-file-signature"></i> Documents</a>
          </div>

          <div class="menu-toggle mt-2" onclick="toggleMenu('utilities-submenu')">
            <div class="nav-link active">
              <i class="fas fa-tools"></i> Utilities
              <i class="fas fa-chevron-down float-end"></i>
            </div>
          </div>
          <div class="submenu show" id="utilities-submenu">
            <a class="nav-link active" href="/document-types"><i class="fas fa-layer-group"></i> Document Types</a>
          </div>

          <hr class="text-white-50" />
          <a class="nav-link" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
      </div>
    </div>

    <div class="col-md-9 col-lg-10">
      <div class="main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Document Types</h2>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#docTypeModal">
            <i class="fas fa-plus me-2"></i>Add New Document Type
          </button>
        </div>

        <div class="row">
          {{#if documentTypes.length}}
            {{#each documentTypes}}
              <div class="col-md-4 mb-3">
                <div class="card h-100">
                  <div class="card-body d-flex flex-column">
                    <div class="d-flex align-items-center mb-2">
                      {{#if icon}}
                        <i class="{{icon}} fa-lg me-2"></i>
                      {{/if}}
                      <div>
                        <h5 class="card-title mb-0">{{name}}</h5>
                        <small class="text-muted">{{code}}</small>
                      </div>
                    </div>
                    <p class="card-text flex-grow-1">{{description}}</p>
                    <div class="d-flex justify-content-between mt-2">
                      <button class="btn btn-sm btn-outline-secondary" type="button" onclick="viewTemplate({{id}})">
                        View
                      </button>
                      <button class="btn btn-sm btn-outline-primary" type="button" onclick="editDocType({{id}})">
                        Edit
                      </button>
                      <button class="btn btn-sm btn-outline-danger" type="button" onclick="deleteDocType({{id}})">
                        Delete
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            {{/each}}
          {{else}}
            <p class="text-muted">No document types configured yet.</p>
          {{/if}}
        </div>
      </div>
    </div>
  </div>
</div>

{{!-- Add/Edit Modal --}}
<div class="modal fade" id="docTypeModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="docTypeForm">
        <div class="modal-header">
          <h5 class="modal-title" id="docTypeModalTitle">Add Document Type</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="docTypeId" name="id" />
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" id="docTypeName" name="name" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Code</label>
              <input type="text" class="form-control" id="docTypeCode" name="code" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Icon (Font Awesome)</label>
              <input type="text" class="form-control" id="docTypeIcon" name="icon" placeholder="fas fa-file-alt" />
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="docTypeDescription" name="description" rows="3"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Template HTML (optional)</label>
              <textarea class="form-control" id="docTypeTemplateHtml" name="templateHtml" rows="5"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

{{!-- Template Preview Modal --}}
<div class="modal fade" id="viewTemplateModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Template Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="templatePreview" class="border p-3 bg-light"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // safely parsed from server â†’ JS
  const docTypes = JSON.parse('{{{json documentTypes}}}');

  function findDocType(id) {
    return docTypes.find((t) => t.id === id);
  }

  function openDocTypeModal(mode, docType) {
    document.getElementById('docTypeId').value = docType?.id || '';
    document.getElementById('docTypeName').value = docType?.name || '';
    document.getElementById('docTypeCode').value = docType?.code || '';
    document.getElementById('docTypeIcon').value = docType?.icon || '';
    document.getElementById('docTypeDescription').value = docType?.description || '';
    document.getElementById('docTypeTemplateHtml').value = docType?.templateHtml || '';
    document.getElementById('docTypeModalTitle').innerText =
      mode === 'edit' ? 'Edit Document Type' : 'Add Document Type';

    const modal = new bootstrap.Modal(document.getElementById('docTypeModal'));
    modal.show();
  }

  function editDocType(id) {
    const t = findDocType(id);
    if (!t) return;
    openDocTypeModal('edit', t);
  }

  function viewTemplate(id) {
    const t = findDocType(id);
    const container = document.getElementById('templatePreview');
    container.innerHTML =
      t && t.templateHtml
        ? t.templateHtml
        : '<p class="text-muted">No template HTML configured.</p>';

    const modal = new bootstrap.Modal(document.getElementById('viewTemplateModal'));
    modal.show();
  }

  async function deleteDocType(id) {
    if (!confirm('Delete this document type?')) return;
    const res = await fetch(`/api/v1/document-types/${id}`, { method: 'DELETE' });
    if (res.ok) window.location.reload();
    else alert('Failed to delete');
  }

  document.getElementById('docTypeForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const form = e.target;
    const data = Object.fromEntries(new FormData(form).entries());
    const id = data.id;

    const method = id ? 'PUT' : 'POST';
    const url = id ? `/api/v1/document-types/${id}` : '/api/v1/document-types`;

    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });

    if (res.ok) window.location.reload();
    else alert('Failed to save document type');
  });
</script>
