<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 px-0">
            <div class="sidebar p-3">
                <div class="text-center mb-4">
                    <h5 class="text-white">WhatsApp Manager</h5>
                    <small class="text-white-50">{{user.firstName}} {{user.lastName}}</small>
                </div>
                
                <nav class="nav flex-column">
                    <!-- WhatsApp Menu -->
                    <div class="menu-toggle" onclick="toggleMenu('whatsapp-submenu')">
                        <div class="nav-link">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                            <i class="fas fa-chevron-down float-end"></i>
                        </div>
                    </div>
                    <div class="submenu show" id="whatsapp-submenu">
                        <a class="nav-link" href="/dashboard">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                        <a class="nav-link active" href="/business">
                            <i class="fas fa-building"></i> Business
                        </a>
                        <a class="nav-link" href="/customers">
                            <i class="fas fa-users"></i> Customers
                        </a>
                        <a class="nav-link" href="/templates">
                            <i class="fas fa-file-alt"></i> Templates
                        </a>
                        <a class="nav-link" href="/campaigns">
                            <i class="fas fa-bullhorn"></i> Campaigns
                        </a>
                        
                    </div>
                    
                    <!-- HR Tools Menu -->
                    {{!-- <div class="menu-toggle" onclick="toggleMenu('hr-submenu')">
                        <div class="nav-link">
                            <i class="fas fa-users-cog"></i> HR Tools
                            <i class="fas fa-chevron-down float-end"></i>
                        </div>
                    </div>
                    <div class="submenu show" id="hr-submenu">
                        <a class="nav-link" href="/employees">
                            <i class="fas fa-user-tie"></i> Employee List
                        </a>
                    </div> --}}
                    
                    <hr class="text-white-50">
                    <a class="nav-link" href="#" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
            <div class="main-content p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>My Businesses</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBusinessModal">
                        <i class="fas fa-plus me-2"></i>Add Business
                    </button>
                </div>

                <!-- Search and Filter -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search businesses...">
                            <button class="btn btn-outline-secondary" type="button" onclick="searchBusinesses()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="categoryFilter" onchange="filterByCategory()">
                            <option value="">All Categories</option>
                            <option value="restaurant">Restaurant</option>
                            <option value="retail">Retail</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="education">Education</option>
                            <option value="technology">Technology</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Businesses Grid -->
                <div class="row" id="businessesGrid">
                    <div class="col-12 text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Business Modal -->
<div class="modal fade" id="addBusinessModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Business</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addBusinessForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="businessName" class="form-label">Business Name *</label>
                            <input type="text" class="form-control" id="businessName" name="businessName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="category" class="form-label">Category *</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">Select Category</option>
                                <option value="restaurant">Restaurant</option>
                                <option value="retail">Retail</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="education">Education</option>
                                <option value="technology">Technology</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="phoneNo" class="form-label">Phone Number</label>
                            <div class="input-group">
                                <span class="input-group-text">+91</span>
                                <input type="tel" class="form-control" id="phoneNo" name="phoneNo" placeholder="9999999999">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="whatsappNo" class="form-label">WhatsApp Number</label>
                            <div class="input-group">
                                <span class="input-group-text">+91</span>
                                <input type="tel" class="form-control" id="whatsappNo" name="whatsappNo" placeholder="9999999999">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="country" class="form-label">Country *</label>
                            <select class="form-select" id="country" name="country" required>
                                <option value="">Select Country</option>
                                <option value="IN">India</option>
                                <option value="US">United States</option>
                                <option value="UK">United Kingdom</option>
                                <option value="CA">Canada</option>
                                <option value="AU">Australia</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="timezone" class="form-label">Timezone</label>
                            <select class="form-select" id="timezone" name="timezone">
                                <option value="Asia/Kolkata">Asia/Kolkata (IST)</option>
                                <option value="America/New_York">America/New_York (EST)</option>
                                <option value="America/Los_Angeles">America/Los_Angeles (PST)</option>
                                <option value="Europe/London">Europe/London (GMT)</option>
                                <option value="Australia/Sydney">Australia/Sydney (AEST)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" placeholder="Brief description of your business"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addBusiness()">Add Business</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Business Modal -->
<div class="modal fade" id="editBusinessModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Business</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editBusinessForm">
                    <input type="hidden" id="editBusinessId" name="id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editBusinessName" class="form-label">Business Name *</label>
                            <input type="text" class="form-control" id="editBusinessName" name="businessName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editCategory" class="form-label">Category *</label>
                            <select class="form-select" id="editCategory" name="category" required>
                                <option value="">Select Category</option>
                                <option value="restaurant">Restaurant</option>
                                <option value="retail">Retail</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="education">Education</option>
                                <option value="technology">Technology</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editPhoneNo" class="form-label">Phone Number</label>
                            <div class="input-group">
                                <span class="input-group-text">+91</span>
                                <input type="tel" class="form-control" id="editPhoneNo" name="phoneNo" placeholder="9999999999">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editWhatsappNo" class="form-label">WhatsApp Number</label>
                            <div class="input-group">
                                <span class="input-group-text">+91</span>
                                <input type="tel" class="form-control" id="editWhatsappNo" name="whatsappNo" placeholder="9999999999">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editCountry" class="form-label">Country *</label>
                            <select class="form-select" id="editCountry" name="country" required>
                                <option value="">Select Country</option>
                                <option value="IN">India</option>
                                <option value="US">United States</option>
                                <option value="UK">United Kingdom</option>
                                <option value="CA">Canada</option>
                                <option value="AU">Australia</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editTimezone" class="form-label">Timezone</label>
                            <select class="form-select" id="editTimezone" name="timezone">
                                <option value="Asia/Kolkata">Asia/Kolkata (IST)</option>
                                <option value="America/New_York">America/New_York (EST)</option>
                                <option value="America/Los_Angeles">America/Los_Angeles (PST)</option>
                                <option value="Europe/London">Europe/London (GMT)</option>
                                <option value="Australia/Sydney">Australia/Sydney (AEST)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="3" placeholder="Brief description of your business"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateBusiness()">Update Business</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteBusinessModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Business</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this business? This action cannot be undone.</p>
                <div class="alert alert-warning">
                    <strong>Business:</strong> <span id="deleteBusinessName"></span><br>
                    <strong>Category:</strong> <span id="deleteBusinessCategory"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteBusiness()">Delete Business</button>
            </div>
        </div>
    </div>
</div>

<script>
    let businesses = [];
    let currentDeleteId = null;

    // Load businesses data
    async function loadBusinesses() {
        try {
            const data = await apiCall('/business'); // <-- already JSON
            businesses = Array.isArray(data) ? data : (data?.data || []);
            displayBusinesses(businesses);
        } catch (error) {
            console.error('Error loading businesses:', error);
            document.getElementById('businessesGrid').innerHTML = 
                '<div class="col-12 text-center text-danger py-4">Error loading businesses</div>';
        }
    }

    // Display businesses in grid
    function displayBusinesses(businessesToShow) {
        const grid = document.getElementById('businessesGrid');
        
        if (!Array.isArray(businessesToShow) || businessesToShow.length === 0) {
            grid.innerHTML = '<div class="col-12 text-center text-muted py-4">No businesses found</div>';
            return;
        }

        grid.innerHTML = businessesToShow.map(business => `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title">${business.businessName || 'Untitled'}</h5>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="editBusiness(${business.id})">
                                        <i class="fas fa-edit me-2"></i>Edit
                                    </a></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteBusiness(${business.id}, '${business.businessName || ''}', '${business.category || ''}')">
                                        <i class="fas fa-trash me-2"></i>Delete
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="mb-2">
                            <span class="badge bg-primary">${business.category || 'No Category'}</span>
                        </div>
                        <p class="card-text text-muted small">${business.description || 'No description provided'}</p>
                        <div class="row text-center">
                            <div class="col-6">
                                <small class="text-muted">Phone</small><br>
                                <small>${business.phoneNo || 'Not provided'}</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">WhatsApp</small><br>
                                <small>${business.whatsappNo || 'Not provided'}</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                ${business.country || 'No country'} • ${business.timezone || 'No timezone'}
                            </small>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <small class="text-muted">
                            Created: ${business.createdAt ? new Date(business.createdAt).toLocaleDateString() : '—'}
                        </small>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Search businesses
    function searchBusinesses() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
        const filtered = (businesses || []).filter(b => 
            (b.businessName || '').toLowerCase().includes(searchTerm) ||
            (b.description || '').toLowerCase().includes(searchTerm) ||
            (b.category || '').toLowerCase().includes(searchTerm)
        );
        displayBusinesses(filtered);
    }

    // Filter by category
    function filterByCategory() {
        const selectedCategory = document.getElementById('categoryFilter').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
        
        let filtered = businesses || [];
        if (selectedCategory) filtered = filtered.filter(b => (b.category || '') === selectedCategory);
        if (searchTerm) {
            filtered = filtered.filter(b => 
                (b.businessName || '').toLowerCase().includes(searchTerm) ||
                (b.description || '').toLowerCase().includes(searchTerm) ||
                (b.category || '').toLowerCase().includes(searchTerm)
            );
        }
        displayBusinesses(filtered);
    }

    // Clear filters
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('categoryFilter').value = '';
        displayBusinesses(businesses);
    }

    // Normalize phone input -> +91xxxxxxxxxx (digits only)
    function normPhone(value) {
        if (!value) return '';
        const digits = String(value).replace(/\D/g, '');
        if (!digits) return '';
        // if already starts with 91 and length 12 (including country), keep +91
        if (digits.length === 12 && digits.startsWith('91')) return '+'.concat(digits);
        // otherwise assume 10-digit local and prefix +91
        if (digits.length === 10) return '+91' + digits;
        // fallback: return with plus
        return '+' + digits;
    }

    // Add business function
    async function addBusiness() {
        const form = document.getElementById('addBusinessForm');
        const formData = new FormData(form);
        
        const businessData = {
            businessName: formData.get('businessName')?.trim(),
            category: formData.get('category'),
            description: formData.get('description')?.trim(),
            phoneNo: normPhone(formData.get('phoneNo')),
            whatsappNo: normPhone(formData.get('whatsappNo')),
            country: formData.get('country'),
            timezone: formData.get('timezone')
        };

        try {
            const data = await apiCall('/business', {
                method: 'POST',
                body: JSON.stringify(businessData)
            }); // <- already JSON

            // success if no error field present
            if (data && !data.error) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('addBusinessModal'));
                modal?.hide();
                form.reset();
                loadBusinesses();
                showAlert('Business added successfully!', 'success');
            } else {
                showAlert((data && (data.message || data.error)) || 'Failed to add business', 'danger');
            }
        } catch (error) {
            showAlert('Network error. Please try again.', 'danger');
        }
    }

    // Edit business function
    function editBusiness(businessId) {
        const business = (businesses || []).find(b => b.id === businessId);
        if (!business) return;

        document.getElementById('editBusinessId').value = business.id;
        document.getElementById('editBusinessName').value = business.businessName || '';
        document.getElementById('editCategory').value = business.category || '';
        document.getElementById('editDescription').value = business.description || '';
        document.getElementById('editCountry').value = business.country || '';
        document.getElementById('editTimezone').value = business.timezone || 'Asia/Kolkata';
        
        // strip + and country for inputs
        const strip91 = v => (v || '').replace(/^\+91/, '');
        document.getElementById('editPhoneNo').value = strip91(business.phoneNo);
        document.getElementById('editWhatsappNo').value = strip91(business.whatsappNo);

        const modal = new bootstrap.Modal(document.getElementById('editBusinessModal'));
        modal.show();
    }

    // Update business function
    async function updateBusiness() {
        const form = document.getElementById('editBusinessForm');
        const formData = new FormData(form);
        
        const businessData = {
            businessName: formData.get('businessName')?.trim(),
            category: formData.get('category'),
            description: formData.get('description')?.trim(),
            phoneNo: normPhone(formData.get('phoneNo')),
            whatsappNo: normPhone(formData.get('whatsappNo')),
            country: formData.get('country'),
            timezone: formData.get('timezone')
        };

        const businessId = formData.get('id');

        try {
            const data = await apiCall(`/business/${businessId}`, {
                method: 'PUT',
                body: JSON.stringify(businessData)
            }); // <- already JSON

            if (data && !data.error) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('editBusinessModal'));
                modal?.hide();
                loadBusinesses();
                showAlert('Business updated successfully!', 'success');
            } else {
                showAlert((data && (data.message || data.error)) || 'Failed to update business', 'danger');
            }
        } catch (error) {
            showAlert('Network error. Please try again.', 'danger');
        }
    }

    // Delete business function
    function deleteBusiness(businessId, businessName, businessCategory) {
        currentDeleteId = businessId;
        document.getElementById('deleteBusinessName').textContent = businessName || '';
        document.getElementById('deleteBusinessCategory').textContent = businessCategory || '';
        
        const modal = new bootstrap.Modal(document.getElementById('deleteBusinessModal'));
        modal.show();
    }

    // Confirm delete business function
    async function confirmDeleteBusiness() {
    if (!currentDeleteId) return;

    try {
      const data = await apiCall(`/business/${currentDeleteId}`, {
        method: 'DELETE'
      }); // apiCall returns JSON or may be undefined on 204

      // Success if no error OR if server returned 204 (apiCall -> undefined)
      if (data === undefined || (data && !data.error)) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteBusinessModal'));
        modal?.hide();
        loadBusinesses();
        showAlert('Business deleted successfully!', 'success');
      } else {
        showAlert((data.message || data.error) || 'Failed to delete business', 'danger');
      }
    } catch (error) {
      showAlert('Network error. Please try again.', 'danger');
    } finally {
      currentDeleteId = null;
    }
  }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        setTimeout(() => { alertDiv.remove(); }, 5000);
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', loadBusinesses);

    // Search on input
    document.getElementById('searchInput').addEventListener('input', searchBusinesses);
</script>
