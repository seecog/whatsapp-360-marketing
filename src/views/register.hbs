<div class="container-fluid vh-100 d-flex align-items-center justify-content-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="card shadow-lg" style="width: 100%; max-width: 500px;">
        <div class="card-body p-4">
            <div class="text-center mb-4">
                <h1 class="h3 mb-2">ðŸ“± WhatsApp Manager</h1>
                <p class="text-muted">Create your account</p>
            </div>

            <div id="alertContainer"></div>

            <form id="registerForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="firstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="firstName" name="firstName" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="lastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="lastName" name="lastName" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="phoneNo" class="form-label">Phone Number</label>
                    <div class="input-group">
                        <span class="input-group-text">+91</span>
                        <input type="tel" class="form-control" id="phoneNo" name="phoneNo" placeholder="9999999999" maxlength="10" pattern="[0-9]{10}" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" name="email" required>
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" name="password" required>
                </div>

                <button type="submit" class="btn btn-primary w-100 mb-3" id="registerBtn">
                    <span id="registerText">Register</span>
                    <span id="loadingText" class="d-none">
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        Creating account...
                    </span>
                </button>
            </form>

            <div class="text-center">
                <p class="mb-0">Already have an account? <a href="/login" class="text-decoration-none">Login here</a></p>
            </div>
        </div>
    </div>
</div>

<script>
    // Show alert helper
    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        alertContainer.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    // Restrict phone number input to digits only
    document.getElementById('phoneNo').addEventListener('input', function (e) {
        this.value = this.value.replace(/\D/g, '');
    });

    // Handle form submit
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const phoneNumber = document.getElementById('phoneNo').value.trim();

        // Validate phone number
        if (!phoneNumber || phoneNumber.length !== 10 || !/^\d{10}$/.test(phoneNumber)) {
            showAlert('Please enter a valid 10-digit phone number', 'danger');
            return;
        }

        const formData = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            phoneNo: '+91' + phoneNumber,
            email: document.getElementById('email').value,
            password: document.getElementById('password').value
        };

        const registerBtn = document.getElementById('registerBtn');
        const registerText = document.getElementById('registerText');
        const loadingText = document.getElementById('loadingText');
        const alertContainer = document.getElementById('alertContainer');

        // Clear previous alerts
        alertContainer.innerHTML = '';

        // Show loading
        registerBtn.disabled = true;
        registerText.classList.add('d-none');
        loadingText.classList.remove('d-none');

        try {
            // apiCall already returns parsed JSON, NOT a Response object
            const data = await apiCall('/users/register', {
                method: 'POST',
                body: JSON.stringify(formData),
                skipAuth: true
            });

            // Determine success based on common patterns (adjust if needed)
            const isSuccess =
                data &&
                (data.success === true ||
                 data.status === 'success' ||
                 data.statusCode === 200 ||
                 data.statusCode === 201);

            if (isSuccess) {
                // Store user data if present
                if (data.data && data.data.user) {
                    localStorage.setItem('user', JSON.stringify(data.data.user));
                }
                if (data.data && data.data.tokens && data.data.tokens.accessToken) {
                    localStorage.setItem('accessToken', data.data.tokens.accessToken);
                }

                // Show success and redirect to login
                showAlert('Registration successful! Redirecting to login...', 'success');

                setTimeout(() => {
                    window.location.replace('/login');
                }, 1500); // small delay so user can see the alert
            } else {
                showAlert(data?.message || 'Registration failed', 'danger');
            }
        } catch (error) {
            console.error('Registration error:', error);
            showAlert(`Network error. Please try again. ${error}`, 'danger');
        } finally {
            // Hide loading
            registerBtn.disabled = false;
            registerText.classList.remove('d-none');
            loadingText.classList.add('d-none');
        }
    });

    // If already logged in, go to dashboard
    if (localStorage.getItem('accessToken')) {
        window.location.href = '/dashboard';
    }
</script>
