<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 px-0">
      <div class="sidebar p-3">
        <div class="text-center mb-2">
          <h5 class="text-white">WhatsApp Manager</h5>
          <small class="text-white-50">{{user.firstName}} {{user.lastName}}</small>
        </div>
        <nav class="nav flex-column">
          <!-- WhatsApp -->
          <div class="menu-toggle" onclick="toggleMenu('whatsapp-submenu')">
            <div class="nav-link">
              <i class="fab fa-whatsapp"></i>
              WhatsApp
              <i class="fas fa-chevron-down float-end"></i>
            </div>
          </div>
          <div class="submenu" id="whatsapp-submenu">
            <a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a class="nav-link" href="/business"><i class="fas fa-building"></i> Business</a>
            <a class="nav-link" href="/customers"><i class="fas fa-users"></i> Customers</a>
            <a class="nav-link" href="/templates"><i class="fas fa-file-alt"></i> Templates</a>
            <a class="nav-link" href="/campaigns"><i class="fas fa-bullhorn"></i> Campaigns</a>
          </div>

          <!-- HR Tools -->
          <div class="menu-toggle" onclick="toggleMenu('hr-submenu')">
            <div class="nav-link">
              <i class="fas fa-users-cog"></i>
              HR Tools
              <i class="fas fa-chevron-down float-end"></i>
            </div>
          </div>
          <div class="submenu" id="hr-submenu">
            <a class="nav-link" href="/employees"><i class="fas fa-user-tie"></i> Employees</a>
            <a class="nav-link" href="/documents"><i class="fas fa-file-signature"></i> Documents</a>
          </div>

          <!-- Utilities -->
          <div class="menu-toggle mt-2" onclick="toggleMenu('utilities-submenu')">
            <div class="nav-link">
              <i class="fas fa-tools"></i>
              Utilities
              <i class="fas fa-chevron-down float-end"></i>
            </div>
          </div>
          <div class="submenu show" id="utilities-submenu">
            <a class="nav-link" href="/document-types">
              <i class="fas fa-layer-group"></i> Document Types
            </a>
            <a class="nav-link active" href="/email-templates">
              <i class="fas fa-envelope-open-text"></i> Email Templates
            </a>
          </div>

          <hr class="text-white-50" />
          <a class="nav-link" href="#" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
          </a>
        </nav>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10">
      <div class="main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Email Templates</h2>
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#emailTemplateModal"
            onclick="openCreateTemplateModal()"
          >
            <i class="fas fa-plus me-2"></i>Add New Email Template
          </button>
        </div>

        <div id="emailTemplatesContainer" class="row g-3">
          <div class="col-12 text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create / Edit Modal -->
<div class="modal fade" id="emailTemplateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="emailTemplateModalTitle">Add Email Template</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="emailTemplateForm">
          <input type="hidden" id="emailTemplateId" />

          <div class="mb-3">
            <label class="form-label" for="templateKey">Template Key</label>
            <input type="text" id="templateKey" class="form-control" required />
            <small class="text-muted">Example: OFFER_LETTER_DEFAULT</small>
          </div>

          <div class="mb-3">
            <label class="form-label" for="templateName">Template Name</label>
            <input type="text" id="templateName" class="form-control" required />
          </div>

          <div class="mb-3">
            <label class="form-label" for="subject">Subject</label>
            <input type="text" id="subject" class="form-control" required />
            <small class="text-muted">
              Placeholders:
              {{'{{employeeName}}'}},
              {{'{{monthYear}}'}}
            </small>
          </div>

          <div class="mb-3">
            <label class="form-label" for="documentTypeId">Document Type (optional)</label>
            <select id="documentTypeId" class="form-select">
              <option value="">-- None --</option>
            </select>
          </div>

          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="isDefault" />
            <label class="form-check-label" for="isDefault">
              Default template for this document type
            </label>
          </div>

          <div class="mb-3">
            <label class="form-label" for="bodyHtml">Body (HTML)</label>
            <textarea id="bodyHtml" class="form-control" rows="10" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="saveEmailTemplate()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- View Modal -->
<div class="modal fade" id="viewEmailTemplateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">View Email Template</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6 id="viewTemplateName"></h6>
        <p><strong>Key:</strong> <span id="viewTemplateKey"></span></p>
        <p><strong>Subject:</strong> <span id="viewSubject"></span></p>
        <p><strong>Document Type:</strong> <span id="viewDocumentType"></span></p>
        <hr />
        <h6>Body Preview</h6>
        <div id="viewBodyHtml" class="border rounded p-3" style="background:#fafafa;"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // NOTE: We use the global apiCall() defined in main.hbs
  // which automatically adds API_BASE + Authorization header
  // and returns parsed JSON (or throws on error).

  let emailTemplates = [];
  let currentEditingId = null;

  // ---------- Load document types for dropdown ----------
  async function loadDocumentTypesForSelect() {
    const select = document.getElementById('documentTypeId');
    if (!select) return;

    // reset options
    select.innerHTML = '<option value="">-- None --</option>';

    try {
      const list = await apiCall('/document-types');
      (list || []).forEach(function (dt) {
        const opt = document.createElement('option');
        opt.value = dt.id;
        opt.textContent =
          dt.documentName ||
          dt.document_name ||
          dt.name ||
          ('#' + dt.id);
        select.appendChild(opt);
      });
    } catch (err) {
      console.error('Error loading document types:', err);
    }
  }

  // ---------- Render email templates in card view ----------
  function renderEmailTemplates() {
    const container = document.getElementById('emailTemplatesContainer');
    if (!container) return;

    if (!emailTemplates.length) {
      container.innerHTML =
        '<div class="col-12 text-center py-4 text-muted">No email templates found. Click "Add New Email Template" to create one.</div>';
      return;
    }

    const cardsHtml = emailTemplates
      .map(function (t) {
        var docType = 'Not linked';
        if (t.documentType) {
          docType =
            t.documentType.documentName ||
            t.documentType.document_name ||
            t.documentType.name ||
            ('#' + t.documentType.id);
        }

        return (
          '<div class="col-md-4">' +
            '<div class="card h-100 shadow-sm">' +
              '<div class="card-body d-flex flex-column">' +
                '<h5 class="card-title">' + (t.templateName || '') + '</h5>' +
                '<h6 class="card-subtitle mb-2 text-muted">' + (t.templateKey || '') + '</h6>' +
                '<p class="mb-1"><strong>Subject:</strong> ' + (t.subject || '') + '</p>' +
                '<p class="mb-1"><strong>Document Type:</strong> ' + docType + '</p>' +
                '<p class="mb-2"><strong>Default:</strong> ' + (t.isDefault ? 'Yes' : 'No') + '</p>' +
                '<div class="mt-auto d-flex justify-content-between">' +
                  '<button class="btn btn-sm btn-outline-secondary" onclick="viewTemplate(' + t.id + ')">' +
                    '<i class="fas fa-eye me-1"></i>View' +
                  '</button>' +
                  '<button class="btn btn-sm btn-outline-primary" onclick="editTemplate(' + t.id + ')">' +
                    '<i class="fas fa-edit me-1"></i>Edit' +
                  '</button>' +
                  '<button class="btn btn-sm btn-outline-danger" onclick="deleteTemplate(' + t.id + ')">' +
                    '<i class="fas fa-trash me-1"></i>Delete' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>'
        );
      })
      .join('');

    container.innerHTML = cardsHtml;
  }

  // ---------- Load from API ----------
  async function loadEmailTemplates() {
    const container = document.getElementById('emailTemplatesContainer');
    if (container) {
      container.innerHTML =
        '<div class="col-12 text-center py-4"><div class="spinner-border text-primary"></div></div>';
    }

    try {
      const list = await apiCall('/email-templates'); // returns JSON array
      emailTemplates = Array.isArray(list) ? list : [];
      renderEmailTemplates();
    } catch (err) {
      console.error('Error fetching email templates:', err);
      if (container) {
        container.innerHTML =
          '<div class="col-12 text-center py-4 text-danger">Failed to load email templates.</div>';
      }
    }
  }

  // ---------- Open create modal ----------
  function openCreateTemplateModal() {
    currentEditingId = null;
    document.getElementById('emailTemplateModalTitle').textContent =
      'Add Email Template';
    document.getElementById('emailTemplateForm').reset();
    document.getElementById('emailTemplateId').value = '';
    document.getElementById('documentTypeId').value = '';
    document.getElementById('isDefault').checked = false;

    var modalEl = document.getElementById('emailTemplateModal');
    var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
  }

  // ---------- Edit template ----------
  function editTemplate(id) {
    var t = emailTemplates.find(function (x) { return x.id === id; });
    if (!t) return;

    currentEditingId = id;
    document.getElementById('emailTemplateModalTitle').textContent =
      'Edit Email Template';
    document.getElementById('emailTemplateId').value = t.id;
    document.getElementById('templateKey').value = t.templateKey || '';
    document.getElementById('templateName').value = t.templateName || '';
    document.getElementById('subject').value = t.subject || '';
    document.getElementById('bodyHtml').value = t.bodyHtml || '';
    document.getElementById('isDefault').checked = !!t.isDefault;

    var docTypeSelect = document.getElementById('documentTypeId');
    docTypeSelect.value = t.documentTypeId ? String(t.documentTypeId) : '';

    var modalEl = document.getElementById('emailTemplateModal');
    var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
  }

  // ---------- View template ----------
  function viewTemplate(id) {
    var t = emailTemplates.find(function (x) { return x.id === id; });
    if (!t) return;

    var docType = 'Not linked';
    if (t.documentType) {
      docType =
        t.documentType.documentName ||
        t.documentType.document_name ||
        t.documentType.name ||
        ('#' + t.documentType.id);
    }

    document.getElementById('viewTemplateName').textContent = t.templateName || '';
    document.getElementById('viewTemplateKey').textContent = t.templateKey || '';
    document.getElementById('viewSubject').textContent = t.subject || '';
    document.getElementById('viewDocumentType').textContent = docType;
    document.getElementById('viewBodyHtml').innerHTML = t.bodyHtml || '';

    var modalEl = document.getElementById('viewEmailTemplateModal');
    var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
  }

  // ---------- Save (create / update) ----------
  async function saveEmailTemplate() {
    var templateKey = document.getElementById('templateKey').value.trim();
    var templateName = document.getElementById('templateName').value.trim();
    var subject = document.getElementById('subject').value.trim();
    var bodyHtml = document.getElementById('bodyHtml').value;
    var docTypeVal = document.getElementById('documentTypeId').value;
    var documentTypeId = docTypeVal ? Number(docTypeVal) : null;
    var isDefault = document.getElementById('isDefault').checked;

    if (!templateKey || !templateName || !subject || !bodyHtml) {
      showAlert('Please fill all required fields.', 'danger');
      return;
    }

    var payload = {
      templateKey: templateKey,
      templateName: templateName,
      subject: subject,
      bodyHtml: bodyHtml,
      documentTypeId: documentTypeId,
      isDefault: isDefault,
    };

    try {
      if (currentEditingId) {
        await apiCall('/email-templates/' + currentEditingId, {
          method: 'PUT',
          body: JSON.stringify(payload),
        });
      } else {
        await apiCall('/email-templates', {
          method: 'POST',
          body: JSON.stringify(payload),
        });
      }

      var modalEl = document.getElementById('emailTemplateModal');
      var modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();

      showAlert('Email template saved successfully.', 'success');
      await loadEmailTemplates();
    } catch (err) {
      console.error('Save error:', err);
      showAlert('Failed to save email template.', 'danger');
    }
  }

  // ---------- Delete ----------
  async function deleteTemplate(id) {
    if (!confirm('Are you sure you want to delete this template?')) return;

    try {
      await apiCall('/email-templates/' + id, {
        method: 'DELETE',
      });

      showAlert('Email template deleted.', 'success');
      await loadEmailTemplates();
    } catch (err) {
      console.error('Delete error:', err);
      showAlert('Failed to delete email template.', 'danger');
    }
  }

  // ---------- Alert helper ----------
  function showAlert(message, type) {
    var alertDiv = document.createElement('div');
    alertDiv.className =
      'alert alert-' + type + ' alert-dismissible fade show position-fixed';
    alertDiv.style.cssText =
      'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML =
      message +
      '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    document.body.appendChild(alertDiv);

    setTimeout(function () {
      if (alertDiv.parentNode) {
        alertDiv.parentNode.removeChild(alertDiv);
      }
    }, 5000);
  }

  // ---------- Init ----------
  document.addEventListener('DOMContentLoaded', function () {
    loadDocumentTypesForSelect();
    loadEmailTemplates();
  });
</script>
