<!-- Campaigns.hbs (Meta templates enabled) -->
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 px-0">
      <div class="sidebar p-3">
        <div class="text-center mb-4">
          <h5 class="text-white">WhatsApp Manager</h5>
          <small class="text-white-50">{{user.firstName}} {{user.lastName}}</small>
        </div>

        <nav class="nav flex-column">
          <div class="menu-toggle" onclick="toggleMenu('whatsapp-submenu')">
            <div class="nav-link">
              <i class="fab fa-whatsapp"></i> WhatsApp
              <i class="fas fa-chevron-down float-end"></i>
            </div>
          </div>
          <div class="submenu show" id="whatsapp-submenu">
            <a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a class="nav-link" href="/business"><i class="fas fa-building"></i> Business</a>
            <a class="nav-link" href="/customers"><i class="fas fa-users"></i> Customers</a>
            <a class="nav-link" href="/templates"><i class="fas fa-file-alt"></i> Templates</a>
            <a class="nav-link active" href="/campaigns"><i class="fas fa-bullhorn"></i> Campaigns</a>
          </div>

          {{!-- <div class="menu-toggle" onclick="toggleMenu('hr-submenu')">
            <div class="nav-link">
              <i class="fas fa-users-cog"></i> HR Tools
              <i class="fas fa-chevron-down float-end"></i>
            </div>
          </div>
          <div class="submenu show" id="hr-submenu">
            <a class="nav-link" href="/employees"><i class="fas fa-user-tie"></i> Employee List</a>
          </div> --}}

          <hr class="text-white-50" />
          <a class="nav-link" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10">
      <div class="main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="fas fa-bullhorn me-2"></i>Campaigns</h2>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
            <i class="fas fa-plus me-1"></i>Create Campaign
          </button>
        </div>

        <!-- Search and Filter -->
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
              <input type="text" class="form-control" id="searchCampaigns" placeholder="Search campaigns..." />
            </div>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="statusFilter">
              <option value="">All Status</option>
              <option value="draft">Draft</option>
              <option value="scheduled">Scheduled</option>
              <option value="running">Running</option>
              <option value="completed">Completed</option>
              <option value="paused">Paused</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="businessFilter">
              <option value="">All Businesses</option>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
              <i class="fas fa-times me-1"></i>Clear
            </button>
          </div>
        </div>

        <!-- Campaigns List -->
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Name</th>
                    <th>Business</th>
                    <th>Template</th>
                    <th>Recipients</th>
                    <th>Status</th>
                    <th>Scheduled At</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="campaignsTableBody">
                  <tr>
                    <td colspan="8" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Create Campaign Modal -->
<div class="modal fade" id="createCampaignModal" tabindex="-1" aria-labelledby="createCampaignModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createCampaignModalLabel">Create New Campaign</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="createCampaignForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="campaignName" class="form-label">Campaign Name *</label>
              <input type="text" class="form-control" id="campaignName" required />
            </div>
            <div class="col-md-6 mb-3">
              <label for="campaignBusiness" class="form-label">Business *</label>
              <select class="form-select" id="campaignBusiness" required>
                <option value="">Select Business</option>
              </select>
            </div>
          </div>

          <!-- META templates only -->
          <div class="mb-3">
            <label for="campaignTemplate" class="form-label">Template (Meta) *</label>
            <select class="form-select" id="campaignTemplate" required title="Loaded from Meta">
              <option value="">Select Template from Meta</option>
            </select>
            <small class="text-muted">Templates are fetched from your Meta account (Graph API).</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Select Customers *</label>
            <div class="border rounded p-3" style="max-height: 220px; overflow-y: auto;">
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="selectAllCustomers" />
                <label class="form-check-label fw-bold" for="selectAllCustomers">Select All Customers</label>
              </div>
              <div id="customersList">
                <p class="text-muted">Please select a business first</p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="scheduleType" class="form-label">Schedule Type *</label>
              <select class="form-select" id="scheduleType" required>
                <option value="immediate">Send Immediately</option>
                <option value="scheduled">Schedule for Later</option>
              </select>
            </div>
            <div class="col-md-6 mb-3" id="scheduleDateTimeGroup" style="display:none;">
              <label for="scheduleDateTime" class="form-label">Schedule Date & Time *</label>
              <input type="datetime-local" class="form-control" id="scheduleDateTime" />
            </div>
          </div>

          <div class="mb-3">
            <label for="campaignDescription" class="form-label">Description</label>
            <textarea class="form-control" id="campaignDescription" rows="3" placeholder="Optional description for this campaign"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="createAndSendCampaign()"><i class="fas fa-paper-plane me-1"></i>Create & Send Now</button>
        <button type="button" class="btn btn-primary" onclick="createCampaign()"><i class="fas fa-save me-1"></i>Create Campaign</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Campaign Modal -->
<div class="modal fade" id="editCampaignModal" tabindex="-1" aria-labelledby="editCampaignModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editCampaignModalLabel">Edit Campaign</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editCampaignForm">
          <input type="hidden" id="editCampaignId" />
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editCampaignName" class="form-label">Campaign Name *</label>
              <input type="text" class="form-control" id="editCampaignName" required />
            </div>
            <div class="col-md-6 mb-3">
              <label for="editCampaignBusiness" class="form-label">Business *</label>
              <select class="form-select" id="editCampaignBusiness" required>
                <option value="">Select Business</option>
              </select>
            </div>
          </div>

          <!-- Edit also picks from Meta -->
          <div class="mb-3">
            <label for="editCampaignTemplate" class="form-label">Template (Meta) *</label>
            <select class="form-select" id="editCampaignTemplate" required>
              <option value="">Select Template from Meta</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Select Customers *</label>
            <div class="border rounded p-3" style="max-height: 220px; overflow-y: auto;">
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="editSelectAllCustomers" />
                <label class="form-check-label fw-bold" for="editSelectAllCustomers">Select All Customers</label>
              </div>
              <div id="editCustomersList"><p class="text-muted">Please select a business first</p></div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editScheduleType" class="form-label">Schedule Type *</label>
              <select class="form-select" id="editScheduleType" required>
                <option value="immediate">Send Immediately</option>
                <option value="scheduled">Schedule for Later</option>
              </select>
            </div>
            <div class="col-md-6 mb-3" id="editScheduleDateTimeGroup" style="display:none;">
              <label for="editScheduleDateTime" class="form-label">Schedule Date & Time *</label>
              <input type="datetime-local" class="form-control" id="editScheduleDateTime" />
            </div>
          </div>

          <div class="mb-3">
            <label for="editCampaignDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editCampaignDescription" rows="3" placeholder="Optional description for this campaign"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="updateCampaign()"><i class="fas fa-save me-1"></i>Update Campaign</button>
      </div>
    </div>
  </div>
</div>

<!-- Campaign Details Modal -->
<div class="modal fade" id="campaignDetailsModal" tabindex="-1" aria-labelledby="campaignDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="campaignDetailsModalLabel">Campaign Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="campaignDetailsContent"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ---- state ----
  let campaigns = [];
  let businesses = [];
  let metaTemplates = [];
  let customers = [];

  // ---- helpers ----
  const getId = (obj) => (obj ? (obj.id ?? obj._id) : undefined);
  const coerceId = (v) => (typeof v === 'string' && /^\d+$/.test(v) ? Number(v) : v);

  async function unwrap(respOrJson) {
    if (!respOrJson) return null;
    if (typeof respOrJson.ok === 'boolean' && typeof respOrJson.json === 'function') {
      if (!respOrJson.ok) throw new Error(await respOrJson.text());
      return respOrJson.json();
    }
    return respOrJson;
  }

  function getBusinessName(businessId) {
    const b = (businesses || []).find((x) => String(getId(x)) === String(businessId));
    return b ? (b.businessName || 'Business') : 'Unknown';
  }

  function getStatusColor(status) {
    const c = { draft:'secondary', scheduled:'warning', running:'primary', completed:'success', paused:'danger' };
    return c[status] || 'secondary';
  }

  // display name of template for a campaign row
  function getCampaignTemplateDisplay(c) {
    if (c.metaTemplateName) {
      return `${c.metaTemplateName} (${c.metaTemplateLanguage || 'en_US'})`;
    }
    // local fallback (shouldn’t happen now, but safe)
    if (c.template && (c.template.displayName || c.template.waName)) {
      return `${c.template.displayName || c.template.waName} (${c.template.category || '—'})`;
    }
    return '—';
  }

  // ---- data loading ----
  async function loadCampaigns() {
    try {
      campaigns = await unwrap(await apiCall('/campaigns')) || [];
      displayCampaigns(campaigns);
    } catch (e) {
      console.error('loadCampaigns', e);
      displayCampaigns([]);
    }
  }

  async function loadBusinesses() {
    try {
      businesses = await unwrap(await apiCall('/business')) || [];
      populateBusinessDropdowns();
    } catch (e) { console.error('loadBusinesses', e); }
  }

  // Load from Meta (NOT local)
  async function loadMetaTemplates() {
    try {
      const resp = await unwrap(await apiCall('/templates/meta'));
      const rows = (resp && (resp.data || resp.templates || resp.items)) || [];
      metaTemplates = normalizeMetaTemplates(rows);
      populateMetaTemplateDropdowns();
    } catch (e) {
      console.error('loadMetaTemplates', e);
      metaTemplates = [];
      populateMetaTemplateDropdowns();
    }
  }

  function normalizeMetaTemplates(rows) {
    const arr = Array.isArray(rows) ? rows : (rows?.data || []);
    // You can filter ONLY APPROVED templates if you want:
    // return arr.filter(r => (r.status || r.approval_status) === 'APPROVED').map(...)
    return arr.map(r => ({
      id: r.id || r.name,
      name: r.name,
      language: r.language || 'en_US',
      category: (r.category || '').toLowerCase(),
      status: r.status || r.approval_status || '—',
    }));
  }

  // ---- UI population ----
  function populateBusinessDropdowns() {
    const ids = ['campaignBusiness', 'editCampaignBusiness', 'businessFilter'];
    ids.forEach((id) => {
      const sel = document.getElementById(id);
      if (!sel) return;
      const first = id === 'businessFilter'
        ? '<option value="">All Businesses</option>'
        : '<option value="">Select Business</option>';
      sel.innerHTML = first + (businesses || [])
        .map(b => `<option value="${getId(b)}">${b.businessName || 'Untitled'}</option>`)
        .join('');
    });
  }

  function populateMetaTemplateDropdowns() {
    const ids = ['campaignTemplate', 'editCampaignTemplate'];
    const opts = (metaTemplates || []).map(t => {
      // pack the needed meta info in data-attrs
      return `<option value="${t.name}" data-lang="${t.language}" data-cat="${t.category}">
        ${t.name} (${t.language}) ${t.status ? '- ' + t.status : ''}
      </option>`;
    }).join('');

    ids.forEach(id => {
      const sel = document.getElementById(id);
      if (!sel) return;
      sel.innerHTML = '<option value="">Select Template from Meta</option>' + opts;
    });
  }

  async function loadCustomersForBusiness(businessId, containerId) {
    const container = document.getElementById(containerId);
    if (!businessId) {
      container.innerHTML = '<p class="text-muted">Please select a business first</p>';
      return;
    }
    try {
      customers = await unwrap(await apiCall(`/customers?businessId=${businessId}`)) || [];
      displayCustomersForSelection(customers, containerId);
    } catch (e) {
      console.error('loadCustomersForBusiness', e);
      container.innerHTML = '<p class="text-muted">Error loading customers</p>';
    }
  }

  function displayCustomersForSelection(list, containerId) {
    const container = document.getElementById(containerId);
    if (!list || list.length === 0) {
      container.innerHTML = '<p class="text-muted">No customers found for this business</p>';
      return;
    }
    container.innerHTML = list.map(c => {
      const id = getId(c);
      const inputId = `cb_${containerId}_${id}`;
      return `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="${id}" id="${inputId}">
          <label class="form-check-label" for="${inputId}">
            ${c.name || 'No Name'} - ${c.phoneE164 || ''}
          </label>
        </div>`;
    }).join('');
  }

  function displayCampaigns(list) {
    const tbody = document.getElementById('campaignsTableBody');
    if (!list || list.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No campaigns found</td></tr>';
      return;
    }
    tbody.innerHTML = list.map(c => {
      const id = getId(c);
      return `
        <tr>
          <td><div><strong>${c.name || 'Untitled'}</strong>${c.description ? `<br><small class="text-muted">${c.description}</small>` : ''}</div></td>
          <td>${getBusinessName(c.businessId)}</td>
          <td>${getCampaignTemplateDisplay(c)}</td>
          <td><span class="badge bg-info">${c.recipientCount || 0} recipients</span></td>
          <td><span class="badge bg-${getStatusColor(c.status)}">${c.status || 'draft'}</span></td>
          <td>${c.scheduledAt ? new Date(c.scheduledAt).toLocaleString() : 'Immediate'}</td>
          <td>${c.createdAt ? new Date(c.createdAt).toLocaleDateString() : '—'}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="viewCampaign('${id}')" title="View"><i class="fas fa-eye"></i></button>
              <button class="btn btn-outline-warning" onclick="editCampaign('${id}')" title="Edit"><i class="fas fa-edit"></i></button>
              <button class="btn btn-outline-success" onclick="sendCampaign('${id}')" title="Send"><i class="fas fa-paper-plane"></i></button>
              <button class="btn btn-outline-danger" onclick="deleteCampaign('${id}')" title="Delete"><i class="fas fa-trash"></i></button>
            </div>
          </td>
        </tr>`;
    }).join('');
  }

  // ---- filters ----
  function filterCampaigns() {
    const q = document.getElementById('searchCampaigns').value.toLowerCase().trim();
    const status = document.getElementById('statusFilter').value;
    const biz = document.getElementById('businessFilter').value;

    const filtered = (campaigns || []).filter(c => {
      const matchesQ = (c.name || '').toLowerCase().includes(q) || (c.description || '').toLowerCase().includes(q);
      const matchesS = !status || c.status === status;
      const matchesB = !biz || String(c.businessId) === String(biz);
      return matchesQ && matchesS && matchesB;
    });
    displayCampaigns(filtered);
  }
  function clearFilters() {
    document.getElementById('searchCampaigns').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('businessFilter').value = '';
    displayCampaigns(campaigns);
  }

  // ---- CRUD helpers ----
  function collectSelected(containerId, selectAllId) {
    return Array.from(
      document.querySelectorAll(`#${containerId} input[type="checkbox"]:not(#${selectAllId}):checked`)
    ).map(cb => coerceId(cb.value));
  }

  function readSelectedMetaTemplate(selectId) {
    const sel = document.getElementById(selectId);
    const opt = sel?.selectedOptions?.[0];
    if (!opt || !opt.value) return null;
    return {
      name: opt.value,
      language: opt.dataset.lang || 'en_US',
      category: (opt.dataset.cat || '').toLowerCase()
    };
  }

  // ---- create / send ----
  async function createCampaign() {
    const form = document.getElementById('createCampaignForm');
    if (!form.checkValidity()) { form.reportValidity(); return; }

    const selected = collectSelected('customersList', 'selectAllCustomers');
    if (selected.length === 0) { alert('Please select at least one customer'); return; }

    const metaTemplate = readSelectedMetaTemplate('campaignTemplate');
    if (!metaTemplate) { alert('Please select a Meta template'); return; }

    const payload = {
      name: document.getElementById('campaignName').value,
      businessId: coerceId(document.getElementById('campaignBusiness').value),
      customerIds: selected,
      scheduleType: document.getElementById('scheduleType').value,
      scheduledAt: document.getElementById('scheduleType').value === 'scheduled'
        ? new Date(document.getElementById('scheduleDateTime').value).toISOString()
        : null,
      description: document.getElementById('campaignDescription').value,
      metaTemplate // <-- send meta template info
    };

    try {
      const created = await unwrap(await apiCall('/campaigns', { method: 'POST', body: JSON.stringify(payload) }));
      campaigns = [created, ...campaigns];
      displayCampaigns(campaigns);
      bootstrap.Modal.getInstance(document.getElementById('createCampaignModal'))?.hide();
      form.reset();
      alert('Campaign created successfully!');
      loadCampaigns();
    } catch (e) {
      alert('Error creating campaign: ' + e.message);
    }
  }

  async function createAndSendCampaign() {
    const form = document.getElementById('createCampaignForm');
    if (!form.checkValidity()) { form.reportValidity(); return; }
    const selected = collectSelected('customersList', 'selectAllCustomers');
    if (selected.length === 0) { alert('Please select at least one customer'); return; }
    if (!confirm('Send this campaign to all selected customers now?')) return;

    const metaTemplate = readSelectedMetaTemplate('campaignTemplate');
    if (!metaTemplate) { alert('Please select a Meta template'); return; }

    const payload = {
      name: document.getElementById('campaignName').value,
      businessId: coerceId(document.getElementById('campaignBusiness').value),
      customerIds: selected,
      scheduleType: 'immediate',
      description: document.getElementById('campaignDescription').value,
      metaTemplate
    };

    try {
      const created = await unwrap(await apiCall('/campaigns', { method: 'POST', body: JSON.stringify(payload) }));
      const id = getId(created);
      const result = await unwrap(await apiCall(`/campaigns/${id}/send`, { method: 'POST' }));
      campaigns = [created, ...campaigns];
      displayCampaigns(campaigns);
      bootstrap.Modal.getInstance(document.getElementById('createCampaignModal'))?.hide();
      form.reset();
      alert(`Campaign created and sent! Sent: ${result?.stats?.sent ?? 0}, Failed: ${result?.stats?.failed ?? 0}`);
      loadCampaigns();
    } catch (e) {
      alert('Error creating/sending campaign: ' + e.message);
    }
  }

  // ---- details / edit / update / delete / send ----
  async function viewCampaign(id) {
    try {
      const c = await unwrap(await apiCall(`/campaigns/${id}`));
      displayCampaignDetails(c);
      new bootstrap.Modal(document.getElementById('campaignDetailsModal')).show();
    } catch { alert('Error loading campaign details'); }
  }

  function displayCampaignDetails(c) {
    document.getElementById('campaignDetailsContent').innerHTML = `
      <div class="row">
        <div class="col-md-6">
          <h6>Campaign Information</h6>
          <p><strong>Name:</strong> ${c.name}</p>
          <p><strong>Description:</strong> ${c.description || 'N/A'}</p>
          <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(c.status)}">${c.status}</span></p>
          <p><strong>Business:</strong> ${getBusinessName(c.businessId)}</p>
          <p><strong>Template:</strong> ${getCampaignTemplateDisplay(c)}</p>
        </div>
        <div class="col-md-6">
          <h6>Schedule Information</h6>
          <p><strong>Schedule Type:</strong> ${c.scheduleType || (c.scheduledAt ? 'scheduled' : 'immediate')}</p>
          <p><strong>Scheduled At:</strong> ${c.scheduledAt ? new Date(c.scheduledAt).toLocaleString() : 'Immediate'}</p>
          <p><strong>Created:</strong> ${c.createdAt ? new Date(c.createdAt).toLocaleString() : '—'}</p>
          <p><strong>Recipients:</strong> ${c.recipientCount || 0}</p>
        </div>
      </div>`;
  }

  async function editCampaign(id) {
    try {
      const c = await unwrap(await apiCall(`/campaigns/${id}`));
      populateEditForm(c);
      new bootstrap.Modal(document.getElementById('editCampaignModal')).show();
    } catch { alert('Error loading campaign for editing'); }
  }

  function populateEditForm(c) {
    const id = getId(c);
    document.getElementById('editCampaignId').value = id;
    document.getElementById('editCampaignName').value = c.name || '';
    document.getElementById('editCampaignBusiness').value = c.businessId || '';
    document.getElementById('editCampaignDescription').value = c.description || '';

    // Set Meta template selection
    const sel = document.getElementById('editCampaignTemplate');
    if (c.metaTemplateName) {
      // find option by name + language (best effort)
      const opt = Array.from(sel.options).find(o => o.value === c.metaTemplateName && (o.dataset.lang || '') === (c.metaTemplateLanguage || 'en_US'));
      if (opt) sel.value = opt.value; // value is the name; language is in data-lang
    } else if (c.template) {
      // Backward compat: show local template in label only
      // (No local option shown in list; prefer Meta only)
    }

    // Schedule
    if (c.scheduledAt) {
      document.getElementById('editScheduleType').value = 'scheduled';
      document.getElementById('editScheduleDateTime').value = new Date(c.scheduledAt).toISOString().slice(0, 16);
      document.getElementById('editScheduleDateTimeGroup').style.display = 'block';
    } else {
      document.getElementById('editScheduleType').value = 'immediate';
      document.getElementById('editScheduleDateTimeGroup').style.display = 'none';
    }

    loadCustomersForBusiness(c.businessId, 'editCustomersList');
  }

  async function updateCampaign() {
    const form = document.getElementById('editCampaignForm');
    if (!form.checkValidity()) { form.reportValidity(); return; }

    const selected = collectSelected('editCustomersList', 'editSelectAllCustomers');
    if (selected.length === 0) { alert('Please select at least one customer'); return; }

    const id = document.getElementById('editCampaignId').value;
    const metaTemplate = readSelectedMetaTemplate('editCampaignTemplate');
    if (!metaTemplate) { alert('Please select a Meta template'); return; }

    const payload = {
      name: document.getElementById('editCampaignName').value,
      businessId: coerceId(document.getElementById('editCampaignBusiness').value),
      customerIds: selected,
      scheduleType: document.getElementById('editScheduleType').value,
      scheduledAt: document.getElementById('editScheduleType').value === 'scheduled'
        ? new Date(document.getElementById('editScheduleDateTime').value).toISOString()
        : null,
      description: document.getElementById('editCampaignDescription').value,
      metaTemplate
    };

    try {
      const data = await unwrap(await apiCall(`/campaigns/${id}`, { method: 'PUT', body: JSON.stringify(payload) }));
      campaigns = (campaigns || []).map(c => String(getId(c)) === String(id) ? data : c);
      displayCampaigns(campaigns);
      bootstrap.Modal.getInstance(document.getElementById('editCampaignModal'))?.hide();
      alert('Campaign updated successfully!');
      loadCampaigns();
    } catch (e) {
      alert('Error updating campaign: ' + e.message);
    }
  }

  async function deleteCampaign(id) {
    if (!confirm('Are you sure you want to delete this campaign?')) return;
    try {
      const resp = await apiCall(`/campaigns/${id}`, { method: 'DELETE' });
      const ok = (typeof resp?.ok === 'boolean') ? resp.ok : true;
      if (!ok) throw new Error(await resp.text());
      campaigns = (campaigns || []).filter(c => String(getId(c)) !== String(id));
      displayCampaigns(campaigns);
      alert('Campaign deleted successfully!');
    } catch (e) {
      alert('Error deleting campaign: ' + e.message);
    }
  }

  async function sendCampaign(id) {
    if (!confirm('Send this campaign now?')) return;
    try {
      const result = await unwrap(await apiCall(`/campaigns/${id}/send`, { method: 'POST' }));
      alert(`Campaign sent! Sent: ${result?.stats?.sent ?? 0}, Failed: ${result?.stats?.failed ?? 0}`);
      loadCampaigns();
    } catch (e) {
      alert('Error sending campaign: ' + e.message);
    }
  }

  // ---- events ----
  function setupEventListeners() {
    document.getElementById('searchCampaigns').addEventListener('input', filterCampaigns);
    document.getElementById('statusFilter').addEventListener('change', filterCampaigns);
    document.getElementById('businessFilter').addEventListener('change', filterCampaigns);

    document.getElementById('campaignBusiness').addEventListener('change', function () {
      document.getElementById('selectAllCustomers').checked = false;
      loadCustomersForBusiness(this.value, 'customersList');
    });
    document.getElementById('editCampaignBusiness').addEventListener('change', function () {
      document.getElementById('editSelectAllCustomers').checked = false;
      loadCustomersForBusiness(this.value, 'editCustomersList');
    });

    document.getElementById('scheduleType').addEventListener('change', function () {
      const g = document.getElementById('scheduleDateTimeGroup');
      if (this.value === 'scheduled') { g.style.display = 'block'; document.getElementById('scheduleDateTime').required = true; }
      else { g.style.display = 'none'; document.getElementById('scheduleDateTime').required = false; }
    });
    document.getElementById('editScheduleType').addEventListener('change', function () {
      const g = document.getElementById('editScheduleDateTimeGroup');
      if (this.value === 'scheduled') { g.style.display = 'block'; document.getElementById('editScheduleDateTime').required = true; }
      else { g.style.display = 'none'; document.getElementById('editScheduleDateTime').required = false; }
    });

    document.getElementById('selectAllCustomers').addEventListener('change', function () {
      document.querySelectorAll('#customersList input[type="checkbox"]').forEach(cb => cb.checked = this.checked);
    });
    document.getElementById('editSelectAllCustomers').addEventListener('change', function () {
      document.querySelectorAll('#editCustomersList input[type="checkbox"]').forEach(cb => cb.checked = this.checked);
    });

    document.getElementById('createCampaignModal').addEventListener('shown.bs.modal', () => {
      const val = document.getElementById('campaignBusiness').value;
      if (val) loadCustomersForBusiness(val, 'customersList');
    });
    document.getElementById('editCampaignModal').addEventListener('shown.bs.modal', () => {
      const val = document.getElementById('editCampaignBusiness').value;
      if (val) loadCustomersForBusiness(val, 'editCustomersList');
    });
  }

  // ---- init ----
  document.addEventListener('DOMContentLoaded', function () {
    loadCampaigns();
    loadBusinesses();
    loadMetaTemplates();  // <- Meta templates!
    setupEventListeners();
  });
</script>
