<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 px-0">
      <div class="sidebar p-3">
        <div class="text-center mb-4">
          <h5 class="text-white">WhatsApp Manager</h5>
          <small class="text-white-50">{{user.firstName}} {{user.lastName}}</small>
        </div>

        <nav class="nav flex-column">
          <!-- WhatsApp Menu -->
          <div class="menu-toggle" onclick="toggleMenu('whatsapp-submenu')">
            <div class="nav-link">
              <i class="fab fa-whatsapp"></i> WhatsApp
              <i class="fas fa-chevron-down float-end"></i>
            </div>
          </div>
          <div class="submenu show" id="whatsapp-submenu">
            <a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a class="nav-link" href="/business"><i class="fas fa-building"></i> Business</a>
            <a class="nav-link active" href="/customers"><i class="fas fa-users"></i> Customers</a>
            <a class="nav-link" href="/templates"><i class="fas fa-file-alt"></i> Templates</a>
            <a class="nav-link" href="/campaigns"><i class="fas fa-bullhorn"></i> Campaigns</a>
            
          </div>

          <!-- HR Tools Menu -->
          {{!-- <div class="menu-toggle" onclick="toggleMenu('hr-submenu')">
            <div class="nav-link">
              <i class="fas fa-users-cog"></i> HR Tools
              <i class="fas fa-chevron-down float-end"></i>
            </div>
          </div>
          <div class="submenu show" id="hr-submenu">
            <a class="nav-link" href="/employees"><i class="fas fa-user-tie"></i> Employee List</a>
          </div> --}}

          <hr class="text-white-50" />
          <a class="nav-link" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10">
      <div class="main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Customers</h2>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
            <i class="fas fa-plus me-2"></i>Add Customer
          </button>
        </div>

        <!-- Search and Filter -->
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="input-group">
              <input type="text" class="form-control" id="searchInput" placeholder="Search customers..." />
              <button class="btn btn-outline-secondary" type="button" onclick="searchCustomers()">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="businessFilter" onchange="filterByBusiness()">
              <option value="">All Businesses</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="tagFilter" onchange="filterByTag()">
              <option value="">All Tags</option>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
              <i class="fas fa-times me-2"></i>Clear
            </button>
          </div>
        </div>

        <!-- Customers Table -->
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Business</th>
                    <th>Tags</th>
                    <th>Added</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="customersTableBody">
                  <tr>
                    <td colspan="6" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addCustomerForm">
          <div class="mb-3">
            <label for="customerBusiness" class="form-label">Business *</label>
            <select class="form-select" id="customerBusiness" name="businessId" required>
              <option value="">Select Business</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="customerName" class="form-label">Name</label>
            <input type="text" class="form-control" id="customerName" name="name" required />
          </div>
          <div class="mb-3">
            <label for="customerPhone" class="form-label">Phone Number (E.164 format)</label>
            <div class="input-group">
              <span class="input-group-text">+91</span>
              <input type="tel" class="form-control" id="customerPhone" name="phoneE164" placeholder="9999999999" required />
            </div>
            <small class="form-text text-muted">Enter 10-digit mobile number without +91</small>
          </div>
          <div class="mb-3">
            <label for="customerTags" class="form-label">Tags (comma separated)</label>
            <input type="text" class="form-control" id="customerTags" name="tags" placeholder="vip, regular, premium" />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="addCustomer()">Add Customer</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Customer Modal -->
<div class="modal fade" id="editCustomerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editCustomerForm">
          <input type="hidden" id="editCustomerId" name="id" />
          <div class="mb-3">
            <label for="editCustomerBusiness" class="form-label">Business *</label>
            <select class="form-select" id="editCustomerBusiness" name="businessId" required>
              <option value="">Select Business</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editCustomerName" class="form-label">Name</label>
            <input type="text" class="form-control" id="editCustomerName" name="name" required />
          </div>
          <div class="mb-3">
            <label for="editCustomerPhone" class="form-label">Phone Number (E.164 format)</label>
            <div class="input-group">
              <span class="input-group-text">+91</span>
              <input type="tel" class="form-control" id="editCustomerPhone" name="phoneE164" placeholder="9999999999" required />
            </div>
            <small class="form-text text-muted">Enter 10-digit mobile number without +91</small>
          </div>
          <div class="mb-3">
            <label for="editCustomerTags" class="form-label">Tags (comma separated)</label>
            <input type="text" class="form-control" id="editCustomerTags" name="tags" placeholder="vip, regular, premium" />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="updateCustomer()">Update Customer</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteCustomerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this customer? This action cannot be undone.</p>
        <div class="alert alert-warning">
          <strong>Customer:</strong> <span id="deleteCustomerName"></span><br />
          <strong>Phone:</strong> <span id="deleteCustomerPhone"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="confirmDeleteCustomer()">Delete Customer</button>
      </div>
    </div>
  </div>
</div>

<script>
  let customers = [];
  let businesses = [];
  let currentDeleteId = null;

  // helpers
  const phoneToE164 = (v) => {
    if (!v) return '';
    const digits = String(v).replace(/\D/g, '');
    if (digits.startsWith('91') && digits.length === 12) return '+' + digits;
    if (digits.length === 10) return '+91' + digits;
    return '+' + digits;
  };
  const coerceId = (v) => (/^\d+$/.test(v) ? Number(v) : v);

  // load businesses
  async function loadBusinesses() {
    try {
      const data = await apiCall('/business');
      businesses = Array.isArray(data) ? data : (data && (data.data || data.items)) || [];
      updateBusinessFilters();
    } catch (err) {
      console.error('Error loading businesses:', err);
      // leave dropdowns with placeholders
    }
  }

  // load customers
  async function loadCustomers() {
    try {
      const data = await apiCall('/customers');
      customers = Array.isArray(data)
        ? data
        : (data && (data.data || data.items || data.customers)) || [];
      displayCustomers(customers);
      updateTagFilter(customers);
    } catch (err) {
      console.error('Error loading customers:', err);
      // fall back gracefully instead of showing a blocking error row
      customers = customers || [];
      displayCustomers(customers);
      updateTagFilter(customers);
    }
  }

  // UI population
  function updateBusinessFilters() {
    const businessFilter = document.getElementById('businessFilter');
    const customerBusinessSelect = document.getElementById('customerBusiness');
    const editCustomerBusinessSelect = document.getElementById('editCustomerBusiness');

    businessFilter.innerHTML = '<option value="">All Businesses</option>';
    customerBusinessSelect.innerHTML = '<option value="">Select Business</option>';
    editCustomerBusinessSelect.innerHTML = '<option value="">Select Business</option>';

    (businesses || []).forEach((b) => {
      const id = b.id ?? b._id;
      const name = b.businessName || 'Untitled';

      const optFilter = new Option(name, id);
      businessFilter.add(optFilter);

      const optAdd = new Option(name, id);
      customerBusinessSelect.add(optAdd);

      const optEdit = new Option(name, id);
      editCustomerBusinessSelect.add(optEdit);
    });
  }

  function updateTagFilter(list) {
    const tagFilter = document.getElementById('tagFilter');
    const tags = new Set();
    (list || []).forEach((c) => (c.tags || []).forEach((t) => tags.add(t)));
    const keep = tagFilter.value;
    tagFilter.innerHTML =
      '<option value="">All Tags</option>' +
      Array.from(tags)
        .map((t) => `<option value="${t}">${t}</option>`)
        .join('');
    tagFilter.value = keep;
  }

  function displayCustomers(customersToShow) {
    const tbody = document.getElementById('customersTableBody');
    if (!customersToShow || customersToShow.length === 0) {
      tbody.innerHTML =
        '<tr><td colspan="6" class="text-center text-muted py-4">No customers found</td></tr>';
      return;
    }

    tbody.innerHTML = customersToShow
      .map((c) => {
        const biz =
          c.business ||
          (businesses || []).find((b) => String(b.id ?? b._id) === String(c.businessId));
        const bizName = biz ? (biz.businessName || '—') : 'No Business';
        const id = c.id ?? c._id;
        return `
          <tr>
            <td>${c.name || 'No Name'}</td>
            <td>${c.phoneE164 || ''}</td>
            <td>${bizName}</td>
            <td>${
              c.tags && c.tags.length
                ? c.tags.map((t) => `<span class="badge bg-secondary me-1">${t}</span>`).join('')
                : '<span class="text-muted">No tags</span>'
            }</td>
            <td>${c.createdAt ? new Date(c.createdAt).toLocaleDateString() : '—'}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editCustomer(${JSON.stringify(
                id
              )})" title="Edit"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer(${JSON.stringify(
                id
              )}, '${(c.name || 'No Name').replace(/'/g, "\\'")}', '${(c.phoneE164 || '').replace(
          /'/g,
          "\\'"
        )}')" title="Delete"><i class="fas fa-trash"></i></button>
            </td>
          </tr>`;
      })
      .join('');
  }

  // filters/search
  function filterByBusiness() {
    const selectedBusinessId = document.getElementById('businessFilter').value;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    const selectedTag = document.getElementById('tagFilter').value;

    let list = customers || [];
    if (selectedBusinessId) list = list.filter((c) => String(c.businessId) === String(selectedBusinessId));
    if (selectedTag) list = list.filter((c) => (c.tags || []).includes(selectedTag));
    if (searchTerm) {
      list = list.filter(
        (c) =>
          (c.name || '').toLowerCase().includes(searchTerm) ||
          (c.phoneE164 || '').includes(searchTerm) ||
          (c.tags || []).some((t) => t.toLowerCase().includes(searchTerm))
      );
    }
    displayCustomers(list);
  }
  function searchCustomers() { filterByBusiness(); }
  function filterByTag() { filterByBusiness(); }
  function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('businessFilter').value = '';
    document.getElementById('tagFilter').value = '';
    displayCustomers(customers);
  }

  // CRUD
  async function addCustomer() {
    const form = document.getElementById('addCustomerForm');
    const fd = new FormData(form);

    const businessIdVal = fd.get('businessId');
    const payload = {
      name: fd.get('name'),
      phoneE164: phoneToE164(fd.get('phoneE164')),
      businessId: coerceId(businessIdVal),
      tags: fd.get('tags')
        ? fd.get('tags').split(',').map((t) => t.trim()).filter(Boolean)
        : [],
      consentAt: new Date().toISOString(),
    };

    try {
      const data = await apiCall('/customers', { method: 'POST', body: JSON.stringify(payload) });

      if (data && !data.error) {
        // Close modal & reset
        bootstrap.Modal.getInstance(document.getElementById('addCustomerModal'))?.hide();
        form.reset();

        // Optimistically add to the list so the user sees it immediately
        const bizObj = (businesses || []).find((b) => String(b.id ?? b._id) === String(payload.businessId));
        const created =
          (data.customer || data.data || data) && typeof (data.customer || data.data || data) === 'object'
            ? (data.customer || data.data || data)
            : { id: Date.now(), ...payload };

        if (bizObj) created.business = bizObj;
        if (!created.createdAt) created.createdAt = new Date().toISOString();

        customers = [created, ...customers];
        displayCustomers(customers);
        updateTagFilter(customers);
        showAlert('Customer added successfully!', 'success');

        // Optional: try background refresh (won’t break UI if it fails)
        loadCustomers();
      } else {
        showAlert((data && (data.message || data.error)) || 'Failed to add customer', 'danger');
      }
    } catch (err) {
      showAlert('Network error. Please try again.', 'danger');
    }
  }

  function editCustomer(customerId) {
    const c = (customers || []).find((x) => String(x.id ?? x._id) === String(customerId));
    if (!c) return;

    document.getElementById('editCustomerId').value = c.id ?? c._id;
    document.getElementById('editCustomerName').value = c.name || '';
    document.getElementById('editCustomerBusiness').value = c.businessId || (c.business && (c.business.id ?? c.business._id)) || '';
    document.getElementById('editCustomerPhone').value = (c.phoneE164 || '').replace(/^\+91/, '');
    document.getElementById('editCustomerTags').value = (c.tags || []).join(', ');

    new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
  }

  async function updateCustomer() {
    const form = document.getElementById('editCustomerForm');
    const fd = new FormData(form);
    const id = fd.get('id');

    const payload = {
      name: fd.get('name'),
      phoneE164: phoneToE164(fd.get('phoneE164')),
      businessId: coerceId(fd.get('businessId')),
      tags: fd.get('tags')
        ? fd.get('tags').split(',').map((t) => t.trim()).filter(Boolean)
        : [],
    };

    try {
      const data = await apiCall(`/customers/${id}`, { method: 'PUT', body: JSON.stringify(payload) });

      if (data && !data.error) {
        bootstrap.Modal.getInstance(document.getElementById('editCustomerModal'))?.hide();
        await loadCustomers();
        showAlert('Customer updated successfully!', 'success');
      } else {
        showAlert((data && (data.message || data.error)) || 'Failed to update customer', 'danger');
      }
    } catch (err) {
      showAlert('Network error. Please try again.', 'danger');
    }
  }

  function deleteCustomer(customerId, customerName, customerPhone) {
    currentDeleteId = customerId;
    document.getElementById('deleteCustomerName').textContent = customerName || '';
    document.getElementById('deleteCustomerPhone').textContent = customerPhone || '';
    new bootstrap.Modal(document.getElementById('deleteCustomerModal')).show();
  }

  async function confirmDeleteCustomer() {
    if (!currentDeleteId) return;
    try {
      const data = await apiCall(`/customers/${currentDeleteId}`, { method: 'DELETE' });
      if (data === undefined || (data && !data.error)) {
        // remove locally
        customers = (customers || []).filter((c) => String(c.id ?? c._id) !== String(currentDeleteId));
        displayCustomers(customers);
        updateTagFilter(customers);

        bootstrap.Modal.getInstance(document.getElementById('deleteCustomerModal'))?.hide();
        showAlert('Customer deleted successfully!', 'success');

        // best-effort refresh
        loadCustomers();
      } else {
        showAlert((data.message || data.error) || 'Failed to delete customer', 'danger');
      }
    } catch (err) {
      showAlert('Network error. Please try again.', 'danger');
    } finally {
      currentDeleteId = null;
    }
  }

  function showAlert(message, type) {
    const el = document.createElement('div');
    el.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    el.style.cssText = 'top:20px;right:20px;z-index:9999;min-width:300px;';
    el.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 5000);
  }

  // init
  document.addEventListener('DOMContentLoaded', async () => {
    await loadBusinesses();
    await loadCustomers();
  });
  document.getElementById('searchInput').addEventListener('input', searchCustomers);
</script>
